/**
 * Модуль для импорта тренировок из текстового формата.
 * 
 * Как использовать импорт:
 * 1. Открыть консоль браузера (F12)
 * 2. Определить переменную rawWorkoutData с данными для импорта:
 *    rawWorkoutData = `
 *    4.09.24
 *    Жим (75) – 9, 6, 6
 *    Тяга (75) – 10, 10, 10
 *    Присяд (75) – 10, 10, 10
 *    
 *    7.09.24
 *    Жим (75) – 7, 7, 7
 *    Тяга (80) – 10, 10, 10
 *    Присяд (80) – 10, 10, 10
 *    `;
 * 3. Вызвать window.activateImport()
 * 4. Нажать появившуюся зеленую кнопку импорта
 * 
 * Формат данных:
 * - Каждая тренировка начинается с даты в формате DD.MM.YY
 * - Каждое упражнение на новой строке
 * - Формат строки упражнения: 
 *   "Название (вес) – повторения" или
 *   "Название – повторения" для упражнений без веса
 * 
 * Примеры форматов:
 * 1. Простой формат:
 *    Жим (80) – 10, 10, 10
 * 
 * 2. Изменение веса в подходах:
 *    Тяга (80) – 13; (85) – 13; (90) – 13
 * 
 * 3. Упражнения без веса:
 *    Подъем ног – 15, 17, 15
 * 
 * Поддерживаемые упражнения с весом:
 * - Жим
 * - Тяга
 * - Присяд
 * 
 * Все остальные упражнения считаются упражнениями без веса (bodyweight).
 * Подъем ног, Отжимания на кольцах, Отжимания на брусьях, Подтягивания прямым хватом, Подтягивания обратным хватом 
 */

import { StorageFactory } from '../services/storage/storage.factory.js';

const storage = StorageFactory.createStorage();

const rawWorkoutData = `4.09.24
Жим (75) – 9, 6, 6
Тяга (75) – 10, 10, 10
Присяд (75) – 10, 10, 10

7.09.24
Жим (75) – 7, 7, 7
Тяга (80) – 10, 10, 10
Присяд (80) – 10, 10, 10

20.09.24
Жим (80) – 8, 6; (75) – 6
Тяга (80) – 10, 10, 10
Присяд (80) – 10, 10, 10

24.09.24
Жим (75) – 10, 9, 6
Тяга (80) – 10, 10, 10
Присяд (80) – 10, 10, 10

26.09.24
Жим (75) – 10, 10, 9
Тяга (80) – 10, 10, 10
Присяд (80) – 10, 10, 10

28.09.24
Жим (80) – 12, 10, 7
Тяга (85) – 11, 11, 11
Присяд (90) – 15, 15, 15

1.10.24
Жим (80) – 9, 8, 8
Тяга (85) – 14, (90) – 12, 10
Присяд (90) – 12, 12, 12

3.10.24
Жим (70) – 10, 10, 10
Тяга (80) – 13, (85) – 13, (90) – 13
Присяд (85) – 15, (90) – 15, (95) – 15

5.10.24
Тяга (80) – 16, (85) – 14, (90) – 12
Присяд (85) – 15, (90) – 15, (95) – 15
Жим (65) – 12, (70) – 11, (75) – 9

8.10.24
Тяга (80) – 15, (85) – 13, (90) – 12
Присяд (90) – 17, (95) – 15, (100) – 11
Жим (70) – 10, 10, 10
Подъем ног – 15, 17, 15
Отжимания на кольцах – 10, 13, 10
Подтягивания обратным хватом – 10, 7, 7

10.10.24
Тяга (60) – 12
Жим (70) – 10, 9
Отжимания на кольцах – 15
Подтягивания прямым хватом – 10
Подъем ног – 15, 10

12.10.24
Присяд (90) – 15, 15, 15
Тяга (80) – 14, 14, (85) – 12
Жим (65) – 13, (70) – 11, 10
Отжимания на кольцах – 15, 10
Подтягивания прямым хватом – 12, 8
Подъем ног – 15, 16, 17, 12

15.10.24
Жим (65) – 13, (70) – 12, 9
Тяга (80) – 15, (85) – 13
Присяд (90) – 13, 13, (95) – 15
Отжимания на кольцах – 15, 13
Подтягивания прямым хватом – 15, 15
Подъем ног – 15, 10, 12, 12

18.10.24
Жим (65) – 13, 12; (70) – 9
Присяд (90) – 16, 16; (95) – 17
Тяга (80) – 13, 14; (85) – 13
Подъем ног – 20, 18, 20
Отжимания на кольцах – 13
Подтягивания прямым хватом – 13

21.10.24
Подъем ног – 15, 20, 20, 10
Отжимания на кольцах – 13, 9
Подтягивания прямым хватом – 13
Подтягивания обратным хватом – 4
Жим (65) – 13, 12, 11
Присяд (95) – 15, 15, 15
Тяга (85) – 13, 12, 11

23.10.24
Подъем ног – 17, 15, 20, 14
Отжимания на кольцах – 15, 8
Подтягивания прямым хватом – 10
Подтягивания обратным хватом – 10
Тяга (85) – 12, 11, 11
Присяд (95) – 15, 15
Жим (65) – 13, 12, 11

25.10.24
Подъем ног – 20, 16, 15, 17
Отжимания на кольцах – 12, 9
Подтягивания прямым хватом – 13
Подтягивания обратным хватом – 8
Тяга (85) – 12, 13; (90) – 12
Присяд (100) – 15, 15, 15
Жим (65) – 14, 13, 12

29.10.24
Отжимания на кольцах – 15, 10
Подтягивания прямым хватом – 13
Подъем ног – 15, 17, 20, 15
Подтягивания обратным хватом – 12
Тяга (85) – 15, 12, 11
Присяд (100) – 13, 14, 15
Жим (65) – 12, 11, 10

31.10.24
Отжимания на кольцах – 17, 8
Подъем ног – 17, 12, 20, 15
Подтягивания обратным хватом – 15
Подтягивания прямым хватом – 10
Тяга (85) – 13, 13, 13
Присяд (100) – 15, 16, 17
Жим (65) – 13, 12, 9

4.11.24
Отжимания на кольцах – 17, 7
Подтягивания прямым хватом – 11
Подъем ног – 20, 20, 20, 20
Подтягивания обратным хватом – 10
Жим (70) – 12, 11, 10
Тяга (90) – 12, 11, 11
Присяд (100) – 15, 15

6.11.24
Отжимания на брусьях – 20
Подтягивания прямым хватом – 15
Подъем ног – 15, 20, 20
Подтягивания обратным хватом – ?
Жим (70) – 10, 9
Тяга (90) – 12, 12
Присяд (100) – 13, 13

8.11.24
Отжимания на кольцах – 17
Подтягивания прямым хватом – 12
Подъем ног – 15, 15, ?, ?
Подтягивания обратным хватом – ?
Жим (70) – 13, 11, 9
Тяга (90) – 15, 13, 12
Присяд (100) – 15; (105) – 15; (100) – 15

11.11.24
Отжимания на кольцах – 14, 13
Подтягивания прямым хватом – 13
Подъем ног – 15, 15, 15, 15
Подтягивания обратным хватом – 12
Жим (70) – 11, 9, 7
Тяга (90) – 15, 13; (85) – 11
Присяд (100) – 15, 15, 15

13.11.24
Отжимания на кольцах – 10, 12
Подтягивания прямым хватом – 10
Подъем ног – 13, 15, 17, 20
Подтягивания обратным хватом – 8
Жим (70) – 10; (65) – 12, 12
Тяга (90) – 14, 14, 14
Присяд (100) – 15, 16, 15

15.11.24
Подъем ног – 17, 18, 17, 15
Отжимания на кольцах – 17, 14
Подтягивания прямым хватом – 17
Подтягивания обратным хватом – 12
Жим (70) – 12, 11, 6; (65) – 5
Тяга (95) – 15, 15, 13
Присяд (105) – 15, 16, 15

18.11.24
Подъем ног – 12, 15, 13, 12
Отжимания на кольцах – 15, 15
Подтягивания прямым хватом – 15
Подтягивания обратным хватом – 12
Жим (70) – 13, 11; (65) – 10
Тяга (95) – 17, 15, 15
Присяд (105) – 15, 15; (100) – 17

20.11.24
Подъем ног – 15, 16, 10, 10
Отжимания на кольцах – 10
Подтягивания прямым хватом – 12
Подтягивания обратным хватом – 13
Отжимания на брусьях – 12
Жим (70) – 11; (65) – 13; 10
Тяга (95) – 15, 15; (90) – 13
Присяд (105) – 10; (100) – 15, 15

22.11.24
Подъем ног – 15, 20, 13, 10
Отжимания на кольцах – 17
Подтягивания прямым хватом – 14
Подтягивания обратным хватом – 12
Отжимания на брусьях – 13
Жим (70) – 12; (65) – 12; (60) – 12
Тяга (95) – 15, 15; (90) – 15
Присяд (105) – 15, 16, 17

25.11.24
Подъем ног – 15, 15, 15, 15
Отжимания на кольцах – 13
Подтягивания прямым хватом – 12
Подтягивания обратным хватом – 11
Отжимания на брусьях – 13
Жим (70) – 10; (65) – 12, 11
Тяга (95) – 15, 15; (90) – 15
Присяд (105) – 15; (100) – 15, 15

27.11.24
Подъем ног – 13, 17, 14, 17
Отжимания на кольцах – 15
Подтягивания прямым хватом – 13, 12
Отжимания на брусьях – 15
Жим (70) – 11, 11, 9
Тяга (95) – 16, 16, 13
Присяд (105) – 13, 14, 15

29.11.24
Подъем ног – 15, 15, 15, 20
Жим (70) – 15, 15, 10
Тяга (95) – 16, 16, 10
Присяд (105) – 12, 14, 16

2.12.24
Подъем ног – 13, 15, 18, 20
Отжимания на кольцах – 15
Подтягивания прямым хватом – 18
Подтягивания обратным хватом – 15
Отжимания на брусьях – 18
Жим (75) – 12, 12, 9
Тяга (100) – 14, 12, 14
Присяд (110) – 15, 15, 16

4.12.24
Подъем ног – 15, 15, 15, 15
Отжимания на кольцах – 13
Подтягивания прямым хватом – 12
Подтягивания обратным хватом – 13
Отжимания на брусьях – 15
Жим (70) – 13, 12, 10
Тяга (100) – 12, 12, 12
Присяд (110) – 12, 13, 14

7.12.24
Подъем ног – 15, 15, 15, 15
Отжимания на кольцах – 17
Подтягивания прямым хватом – 12
Подтягивания обратным хватом – 10
Отжимания на брусьях – 12
Жим (75) – 10, 10, 10
Тяга (100) – 12, 12, 12
Присяд (110) – 8, 8, 8

9.12.24
Подъем ног – 15, 15, 17, 16
Отжимания на кольцах – 15
Подтягивания прямым хватом – 10
Отжимания на брусьях – 15
Жим (75) – 11, 10, 9
Тяга (100) – 12, 13, 14
Присяд (110) – 10, 12, 14

11.12.24
Подъем ног – 15, 17, 17, 17
Отжимания на кольцах – 20
Подтягивания прямым хватом – 13
Подтягивания обратным хватом – 15
Отжимания на брусьях – 15
Жим (75) – 12, 13, 10
Тяга (100) – 15, 15, 15
Присяд (110) – 15, 15, 15

13.12.24
Подъем ног – 17, 17, 17, 17
Отжимания на кольцах – 15
Подтягивания прямым хватом – 13
Подтягивания обратным хватом – 15
Отжимания на брусьях – 20
Жим (75) – 10, 11, 12
Тяга (100) – 14, 15, 14
Присяд (110) – 15, 15, 16

17.12.24
Подъем ног – 17, 17, 15, 20
Отжимания на кольцах – 10
Подтягивания прямым хватом – 15
Подтягивания обратным хватом – 13
Отжимания на брусьях – 20
Жим (80) – 10, 10, 10
Тяга (100) – 13, 12, 12
Присяд (110) – 12, 12, 12

23.12.24
Подъем ног – 15, 15, 15, 15
Отжимания на кольцах – 10
Подтягивания прямым хватом – 10
Подтягивания обратным хватом – 10
Отжимания на брусьях – 13
Жим (60) – 10; (65) – 10; (70) – 10
Тяга (90) – 10, 11, 12
Присяд (100) – 8, 10, 12

25.12.24
Подъем ног – 17, 17, 17, 17
Отжимания на кольцах – 20
Подтягивания прямым хватом – 15
Подтягивания обратным хватом – 15
Отжимания на брусьях – 18
Жим (80) – 10, 9
Тяга (100) – 12, 14
Присяд (110) – 12, 14

27.12.24
Подъем ног – 18, 18, 20, 20
Отжимания на кольцах – 18
Подтягивания прямым хватом – 15
Подтягивания обратным хватом – 16
Отжимания на брусьях – 20
Жим (80) – 11, 10, 9
Тяга (100) – 14, 13, 10
Присяд (110) – 15, 16, 17

30.12.24
Подъем ног – 18, 18, 20, 20
Отжимания на кольцах – 17
Подтягивания прямым хватом – 17
Подтягивания обратным хватом – 10
Отжимания на брусьях – 15
Жим (80) – 10, 9, 8
Тяга (100) – 13, 12, 13
Присяд (110) – 15, 15, 15

1.1.25
Подъем ног – 15, 15, 15, 15
Отжимания на кольцах – 10
Подтягивания прямым хватом – 9
Подтягивания обратным хватом – 10
Отжимания на брусьях – 13
Жим (80) – 8, 8; 9
Тяга (100) – 13, 13, 13
Присяд (115) – 12, 13, 14

3.1.25
Подъем ног – 15, 15, 15, 15
Отжимания на кольцах – 10
Подтягивания прямым хватом – 10
Подтягивания обратным хватом – 10
Отжимания на брусьях – 13
Тяга (100) – 12, 12, 12
Жим (80) – 10, 10, 10
Присяд (115) – 13, 14, 15

6.1.25
Подъем ног – 13, 13, 13, 13
Отжимания на кольцах – 8
Подтягивания прямым хватом – 8
Подтягивания обратным хватом – 8
Отжимания на брусьях – 8
Тяга (100) – 10, 11, 12
Жим (75) – 10, 10; (70) – 10
Присяд (110) – 10, 10, 10

8.1.25
Подъем ног – 15, 15, 15, 15
Отжимания на кольцах – 14
Подтягивания прямым хватом – 8
Подтягивания обратным хватом – 10
Отжимания на брусьях – 9
Жим (80) – 9, 9, 9
Тяга (100) – 12, 12, 12

10.1.25
Подъем ног – 17, 15, 15, 17
Отжимания на кольцах – 15
Подтягивания прямым хватом – 11
Подтягивания обратным хватом – 10
Отжимания на брусьях – 13
Тяга (100) – 12, 12, 13
Жим (80) – 8; (75) – 9, 10
Присяд (115) – 10, 11, 12`;  // и так далее, вставьте все ваши данные

export function parseWorkoutData(rawData) {
    const workouts = [];
    const lines = rawData.split('\n');
    let currentWorkout = null;

    for (let line of lines) {
        line = line.trim();
        if (!line) continue;

        // Проверяем, является ли строка датой
        const dateMatch = line.match(/(\d{1,2})\.(\d{1,2})\.(\d{2})/);
        if (dateMatch) {
            if (currentWorkout) {
                workouts.push(currentWorkout);
            }
            const [_, day, month, year] = dateMatch;
            const date = `20${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            currentWorkout = {
                id: Date.now() + Math.random(),
                date,
                exercises: []
            };
            continue;
        }

        if (!currentWorkout) continue;

        // Парсинг упражнений
        const exerciseData = parseExerciseLine(line);
        if (exerciseData) {
            currentWorkout.exercises.push(exerciseData);
        }
    }

    if (currentWorkout) {
        workouts.push(currentWorkout);
    }

    return workouts;
}

function parseExerciseLine(line) {
    if (line.includes('НЕ СОВПАДАЕТ') || line.includes('?')) return null;

    const exerciseMatch = line.match(/^(.+?) – (.+)$/);
    if (!exerciseMatch) return null;

    let [_, exerciseName, setsData] = exerciseMatch;
    
    // Извлекаем вес из названия упражнения
    let initialWeight = null;
    const nameWeightMatch = exerciseName.match(/\((\d+)\)/);
    if (nameWeightMatch) {
        initialWeight = parseInt(nameWeightMatch[1]);
        exerciseName = exerciseName.replace(/\s*\(\d+\)\s*/, '').trim();
    }
    
    // Определяем тип упражнения
    const type = ['Тяга', 'Жим', 'Присяд'].includes(exerciseName) ? 'weighted' : 'bodyweight';
    
    // Парсим подходы и веса
    const sets = [];
    let currentWeight = initialWeight;
    
    // Разбиваем на группы по точке с запятой
    const groups = setsData.split(';').map(g => g.trim());
    
    for (const group of groups) {
        // Проверяем наличие нового веса в группе
        const weightMatch = group.match(/\((\d+)\)/);
        if (weightMatch && type === 'weighted') {
            currentWeight = parseInt(weightMatch[1]);
        }
        
        // Получаем повторения после тире или после веса
        let repsString = group.includes('–') ? 
            group.split('–')[1].trim() : 
            group.replace(/\(\d+\)\s*–?\s*/, '').trim();
        
        // Разбиваем повторения на отдельные подходы
        const reps = repsString.split(',').map(r => parseInt(r.trim()));
        
        // Добавляем каждый подход
        reps.forEach(rep => {
            if (!isNaN(rep)) {
                sets.push({
                    reps: rep,
                    weight: type === 'weighted' ? currentWeight : null
                });
            }
        });
    }

    return {
        name: exerciseName,
        type: type,
        sets: sets
    };
}

export function importWorkoutData() {
    const parsedWorkouts = parseWorkoutData(rawWorkoutData);
    
    localStorage.removeItem('exercises');
    
    parsedWorkouts.forEach(workout => {
        storage.saveWorkoutToHistory(workout);
    });
    
    return parsedWorkouts.length;
} 